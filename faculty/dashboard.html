<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Faculty Dashboard | Edunova</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="../css/dashboard.css">
<link rel="icon" href="../images/logo.png">
</head>

<body>

<!-- ================= TOPBAR ================= -->
<div class="topbar">
  <button class="hamburger" onclick="toggleSidebar()">â˜°</button>

  <div class="brand">
    <img src="../images/logo.png" class="logo">
    <span>Edunova â€“ Faculty</span>
  </div>

  <button class="logout-btn" id="logoutBtn">Logout</button>
</div>

<!-- OVERLAY -->
<div class="overlay" id="overlay" onclick="closeSidebar()"></div>

<div class="layout">

  <!-- ================= SIDEBAR ================= -->
  <div class="sidebar" id="sidebar">

    <div class="sidebar-header">
      <img src="../images/logo.png">
      <span>Edunova</span>
    </div>

    <a class="active" data-target="homeCard">Dashboard</a>
    <a href="attendance-upload.html">Attendance</a>
    <a href="marks.html">Internal Marks</a>
    <a data-target="profileCard">Profile</a>

  </div>

  <!-- ================= MAIN ================= -->
  <div class="main">

    <!-- ===== HOME DASHBOARD ===== -->
    <div class="card" id="homeCard">
      <h3 id="welcomeTitle">Welcome ðŸ‘‹</h3>
      <p class="note">
        Manage your classes, attendance and internal marks from here.
      </p>

      <!-- QUICK STATS -->
      <div class="stats-container">
        <div class="stat-box">
          <h2 id="classCount">â€“</h2>
          <p>Classes</p>
        </div>

        <div class="stat-box">
          <h2 id="subjectCount">â€“</h2>
          <p>Subjects</p>
        </div>

        <div class="stat-box">
          <h2 id="studentCount">â€“</h2>
          <p>Students</p>
        </div>
      </div>

      <!-- QUICK ACTIONS -->
      <div style="margin-top:20px; display:flex; gap:12px; flex-wrap:wrap;">
        <button class="primary-btn" onclick="openTeachingPanel()">
          Open Teaching Panel
        </button>
        <button class="secondary-btn" onclick="location.href='attendance-upload.html'">
          Take Attendance
        </button>
        <button class="secondary-btn" onclick="location.href='marks.html'">
          Enter Marks
        </button>
      </div>
    </div>

    <!-- ===== PROFILE (COMMON) ===== -->
    <div class="card hidden profile-page" id="profileCard">
      <iframe
        src="../common/profile.html"
        class="profile-iframe"
        style="width:100%;height:80vh;border:none;">
      </iframe>
    </div>

    <!-- ===== TEACHING PANEL ===== -->
    <div class="card hidden" id="teachingPanel">
      <h3 id="contextTitle">Select Class & Subject</h3>
      <p class="note" id="contextNote">
        Attendance, marks and student list will load here.
      </p>

      <div class="controls">
        <div>
          <label>Class</label>
          <select id="classSelect">
            <option value="">Select Class</option>
          </select>
        </div>

        <div>
          <label>Subject</label>
          <select id="subjectSelect" disabled>
            <option value="">Select Subject</option>
          </select>
        </div>
      </div>

      <div id="dynamicContent"></div>
    </div>

  </div>
</div>

<!-- ================= AUTH + BASIC CHECK ================= -->
<script type="module">
import { auth, db } from "../js/firebase.js";
import { onAuthStateChanged, signOut } from
  "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { doc, getDoc } from
  "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    location.replace("/index.html");
    return;
  }

  try {
    const userSnap = await getDoc(doc(db, "users", user.uid));
    if (!userSnap.exists() || userSnap.data().role !== "faculty") {
      location.replace("/index.html");
      return;
    }

    if (userSnap.data().firstLogin === true) {
      location.replace("/faculty/set-password.html");
      return;
    }

    const facultySnap = await getDoc(doc(db, "faculties", user.uid));
    if (!facultySnap.exists() || facultySnap.data().profileCompleted !== true) {
      location.replace("/faculty/setup-teaching.html");
      return;
    }

    document.getElementById("welcomeTitle").innerText =
      `Welcome, ${userSnap.data().name || "Faculty"} ðŸ‘‹`;

  } catch (err) {
    console.error(err);
    location.replace("/index.html");
  }
});

document.getElementById("logoutBtn").onclick = async () => {
  await signOut(auth);
  location.replace("/index.html");
};

// Teaching panel open
window.openTeachingPanel = () => {
  document.getElementById("teachingPanel").classList.remove("hidden");
  document.getElementById("teachingPanel")
    .scrollIntoView({ behavior: "smooth" });
};
</script>

<!-- ================= SIDEBAR SECTION SWITCH ================= -->
<script>
document.querySelectorAll(".sidebar a[data-target]").forEach(link => {
  link.addEventListener("click", (e) => {
    e.preventDefault(); // ðŸ”¥ THIS PREVENTS /faculty/profile.html

    const targetId = link.dataset.target;

    document.querySelectorAll(".main .card").forEach(card => {
      card.classList.add("hidden");
    });

    document.getElementById(targetId).classList.remove("hidden");

    // Active state
    document.querySelectorAll(".sidebar a").forEach(a => a.classList.remove("active"));
    link.classList.add("active");
  });
});
</script>

<!-- ================= FACULTY LOGIC ================= -->
<script type="module" src="js/faculty-dashboard.js"></script>

</body>
</html>
